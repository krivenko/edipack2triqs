

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>edipack2triqs.solver &mdash; edipack2triqs  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=df4ffeb6" />
      <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />

  
    <link rel="shortcut icon" href="../../_static/triqs_favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #7E588A" >

          
          
          <a href="../../index.html" class="icon icon-home">
            edipack2triqs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../install.html#release-version-from-anaconda">Release version from Anaconda</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../install.html#current-development-version-from-github">Current development version from GitHub</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation.html">Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../documentation.html#module-edipack2triqs.solver">Solver class</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.__init__"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.hloc"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.hloc</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.U"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.U</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.bath"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.bath</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.solve"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.solve()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.e_pot"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.e_pot</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.e_kin"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.e_kin</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.densities"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.densities</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.double_occ"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.double_occ</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.superconductive_phi"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.superconductive_phi</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.superconductive_phi_arg"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.superconductive_phi_arg</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.magnetization"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.magnetization</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.g_iw"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.g_iw</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.g_an_iw"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.g_an_iw</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.Sigma_iw"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.Sigma_iw</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.Sigma_an_iw"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.Sigma_an_iw</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.g_w"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.g_w</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.g_an_w"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.g_an_w</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.Sigma_w"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.Sigma_w</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.Sigma_an_w"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.Sigma_an_w</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../documentation.html#module-edipack2triqs.bath">Objects representing sets of bath parameters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.Bath"><code class="docutils literal notranslate"><span class="pre">Bath</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathNormal"><code class="docutils literal notranslate"><span class="pre">BathNormal</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathNormal.nbath"><code class="docutils literal notranslate"><span class="pre">BathNormal.nbath</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathNormal.eps"><code class="docutils literal notranslate"><span class="pre">BathNormal.eps</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathNormal.U"><code class="docutils literal notranslate"><span class="pre">BathNormal.U</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathNormal.Delta"><code class="docutils literal notranslate"><span class="pre">BathNormal.Delta</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathNormal.V"><code class="docutils literal notranslate"><span class="pre">BathNormal.V</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathNormal.ed_mode"><code class="docutils literal notranslate"><span class="pre">BathNormal.ed_mode</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathHybrid"><code class="docutils literal notranslate"><span class="pre">BathHybrid</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathHybrid.nbath"><code class="docutils literal notranslate"><span class="pre">BathHybrid.nbath</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathHybrid.eps"><code class="docutils literal notranslate"><span class="pre">BathHybrid.eps</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathHybrid.U"><code class="docutils literal notranslate"><span class="pre">BathHybrid.U</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathHybrid.Delta"><code class="docutils literal notranslate"><span class="pre">BathHybrid.Delta</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathHybrid.V"><code class="docutils literal notranslate"><span class="pre">BathHybrid.V</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathHybrid.ed_mode"><code class="docutils literal notranslate"><span class="pre">BathHybrid.ed_mode</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathGeneral"><code class="docutils literal notranslate"><span class="pre">BathGeneral</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathGeneral.nbath"><code class="docutils literal notranslate"><span class="pre">BathGeneral.nbath</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathGeneral.hvec"><code class="docutils literal notranslate"><span class="pre">BathGeneral.hvec</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathGeneral.nsym"><code class="docutils literal notranslate"><span class="pre">BathGeneral.nsym</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathGeneral.V"><code class="docutils literal notranslate"><span class="pre">BathGeneral.V</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.bath.BathGeneral.l"><code class="docutils literal notranslate"><span class="pre">BathGeneral.l</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../documentation.html#module-edipack2triqs.fit">Bath fitting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../documentation.html#edipack2triqs.fit.BathFittingParams"><code class="docutils literal notranslate"><span class="pre">BathFittingParams</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.fit.BathFittingParams.scheme"><code class="docutils literal notranslate"><span class="pre">BathFittingParams.scheme</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.fit.BathFittingParams.method"><code class="docutils literal notranslate"><span class="pre">BathFittingParams.method</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.fit.BathFittingParams.grad"><code class="docutils literal notranslate"><span class="pre">BathFittingParams.grad</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.fit.BathFittingParams.tol"><code class="docutils literal notranslate"><span class="pre">BathFittingParams.tol</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.fit.BathFittingParams.stop"><code class="docutils literal notranslate"><span class="pre">BathFittingParams.stop</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.fit.BathFittingParams.niter"><code class="docutils literal notranslate"><span class="pre">BathFittingParams.niter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.fit.BathFittingParams.n_iw"><code class="docutils literal notranslate"><span class="pre">BathFittingParams.n_iw</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.fit.BathFittingParams.weight"><code class="docutils literal notranslate"><span class="pre">BathFittingParams.weight</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.fit.BathFittingParams.norm"><code class="docutils literal notranslate"><span class="pre">BathFittingParams.norm</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.fit.BathFittingParams.pow"><code class="docutils literal notranslate"><span class="pre">BathFittingParams.pow</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.fit.BathFittingParams.minimize_ver"><code class="docutils literal notranslate"><span class="pre">BathFittingParams.minimize_ver</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../documentation.html#edipack2triqs.fit.BathFittingParams.minimize_hh"><code class="docutils literal notranslate"><span class="pre">BathFittingParams.minimize_hh</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.chi2_fit_bath"><code class="docutils literal notranslate"><span class="pre">EDIpackSolver.chi2_fit_bath()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Usage examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#orbital-impurity-with-hubbard-kanamori-interaction">3 orbital impurity with Hubbard-Kanamori interaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#dmft-study-of-superconductivity-in-the-attractive-hubbard-model">DMFT study of superconductivity in the attractive Hubbard model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ChangeLog.html">Changelog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../ChangeLog.html#version-0-8-0">Version 0.8.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ChangeLog.html#version-0-7-0">Version 0.7.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ChangeLog.html#version-0-6-0">Version 0.6.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ChangeLog.html#version-0-5-0">Version 0.5.0</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About edipack2triqs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../about.html#license">License</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../about.html#usage-disclaimer">Usage disclaimer</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #7E588A" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">edipack2triqs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">edipack2triqs.solver</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for edipack2triqs.solver</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">TRIQS interface to **EDIpack** exact diagonalization solver.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tempfile</span><span class="w"> </span><span class="kn">import</span> <span class="n">TemporaryDirectory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">NoneType</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">warnings</span><span class="w"> </span><span class="kn">import</span> <span class="n">warn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpi4py</span><span class="w"> </span><span class="kn">import</span> <span class="n">MPI</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">triqs.operators</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">op</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">triqs.gf</span><span class="w"> </span><span class="kn">import</span> <span class="n">BlockGf</span><span class="p">,</span> <span class="n">Gf</span><span class="p">,</span> <span class="n">MeshImFreq</span><span class="p">,</span> <span class="n">MeshReFreq</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">edipack2py</span><span class="w"> </span><span class="kn">import</span> <span class="n">global_env</span> <span class="k">as</span> <span class="n">ed</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.util</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">IndicesType</span><span class="p">,</span>
                   <span class="n">validate_fops_up_dn</span><span class="p">,</span>
                   <span class="n">is_spin_diagonal</span><span class="p">,</span>
                   <span class="n">write_config</span><span class="p">,</span>
                   <span class="n">chdircontext</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.bath</span><span class="w"> </span><span class="kn">import</span> <span class="n">Bath</span><span class="p">,</span> <span class="n">BathNormal</span><span class="p">,</span> <span class="n">BathHybrid</span><span class="p">,</span> <span class="n">BathGeneral</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.hamiltonian</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse_hamiltonian</span><span class="p">,</span> <span class="n">_is_density</span><span class="p">,</span> <span class="n">_is_density_density</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.fit</span><span class="w"> </span><span class="kn">import</span> <span class="n">BathFittingParams</span><span class="p">,</span> <span class="n">_chi2_fit_bath</span>


<div class="viewcode-block" id="EDIpackSolver">
<a class="viewcode-back" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EDIpackSolver</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class represents the **EDIpack** exact diagonalization library and</span>
<span class="sd">    incapsulates its internal state. Its methods and attributes allow to perform</span>
<span class="sd">    ED calculations and to access their results.</span>

<span class="sd">    .. note::</span>

<span class="sd">        At most one instance of this type can exists at any time. An attempt to</span>
<span class="sd">        create more such objects will raise an :py:class:`AssertionError`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># EDIpack maintains the state of a simulation as a set of global variables.</span>
    <span class="c1"># Therefore, this state must be controlled by at most one EDIpackSolver</span>
    <span class="c1"># instance at any time.</span>
    <span class="n">instance_count</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Default configuration</span>
    <span class="n">default_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># DMFT</span>
        <span class="s2">&quot;NLOOP&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;DMFT_ERROR&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;NSUCCESS&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="c1"># Hartree-Fock</span>
        <span class="s2">&quot;HFMODE&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;XMU&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="c1"># Phonons</span>
        <span class="s2">&quot;PH_TYPE&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;NPH&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="c1"># Fixed density calculations</span>
        <span class="s2">&quot;NREAD&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;NERR&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;NDELTA&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;NCOEFF&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="c1"># ED</span>
        <span class="s2">&quot;ED_USE_KANAMORI&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;ED_READ_UMATRIX&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;PRINT_SECTOR_EIGENVALUES&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;ED_PRINT_SIGMA&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;ED_PRINT_G&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;ED_PRINT_G0&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;RDM_FLAG&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;ED_TWIN&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;ED_SECTORS&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;ED_SECTORS_SHIFT&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;ED_SOLVE_OFFDIAG_GF&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>   <span class="c1"># TODO</span>
        <span class="s2">&quot;ED_ALL_G&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;ED_OFFSET_BATH&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="c1"># TODO: Susceptibilities</span>
        <span class="s2">&quot;LTAU&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>               <span class="c1"># TODO: To be set in solve()</span>
        <span class="s2">&quot;CHISPIN_FLAG&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>      <span class="c1"># TODO: To be set in __init__()</span>
        <span class="s2">&quot;CHIDENS_FLAG&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>      <span class="c1"># TODO: To be set in __init__()</span>
        <span class="s2">&quot;CHIPAIR_FLAG&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>      <span class="c1"># TODO: To be set in __init__()</span>
        <span class="s2">&quot;CHIEXCT_FLAG&quot;</span><span class="p">:</span> <span class="kc">False</span>       <span class="c1"># TODO: To be set in __init__()</span>
    <span class="p">}</span>

<div class="viewcode-block" id="EDIpackSolver.__init__">
<a class="viewcode-back" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="c1"># noqa: C901</span>
                 <span class="n">hamiltonian</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">Operator</span><span class="p">,</span>
                 <span class="n">fops_imp_up</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">IndicesType</span><span class="p">],</span>
                 <span class="n">fops_imp_dn</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">IndicesType</span><span class="p">],</span>
                 <span class="n">fops_bath_up</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">IndicesType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
                 <span class="n">fops_bath_dn</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">IndicesType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
                 <span class="o">**</span><span class="n">kwargs</span>
                 <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize internal state of the underlying **EDIpack** solver.</span>

<span class="sd">        The fundamental operator sets (**fops** for short) define sizes of</span>
<span class="sd">        impurity and bath Hilbert spaces. The expected **fops** objects are</span>
<span class="sd">        lists of tuples (pairs). Each element ``(b, i)`` of such a list</span>
<span class="sd">        corresponds to a single fermionic degree of freedom created by</span>
<span class="sd">        the many-body operator ``c_dag(b, i)``. ``b`` and ``i`` are a (string or</span>
<span class="sd">        integer) block index and an index within a block respectively, which</span>
<span class="sd">        are used to construct output :py:class:`Green&#39;s function</span>
<span class="sd">        containers &lt;triqs.gf.block_gf.BlockGf&gt;`.</span>

<span class="sd">        :param hamiltonian: Many-body electronic Hamiltonian to diagonalize.</span>
<span class="sd">            Symmetries of this Hamiltonian are automatically analyzed and</span>
<span class="sd">            dictate the choice of **EDIpacks**&#39;s</span>
<span class="sd">            :f:var:`ED mode &lt;f/ed_input_vars/ed_mode&gt;` and</span>
<span class="sd">            :f:mod:`bath geometry &lt;f/ed_bath&gt;`. This choice</span>
<span class="sd">            remains unchangeable throughout object&#39;s lifetime.</span>
<span class="sd">        :type triqs.operators.operators.Operator:</span>

<span class="sd">        :param fops_imp_up: Fundamental operator set for spin-up impurity</span>
<span class="sd">            degrees of freedom.</span>
<span class="sd">        :type fops_imp_up: list[tuple[int | str, int | str]]</span>

<span class="sd">        :param fops_imp_dn: Fundamental operator set for spin-down impurity</span>
<span class="sd">            degrees of freedom.</span>
<span class="sd">        :type fops_imp_dn: list[tuple[int | str, int | str]]</span>

<span class="sd">        :param fops_bath_up: Fundamental operator set for spin-up bath</span>
<span class="sd">            degrees of freedom. Must be empty for calculations without bath.</span>
<span class="sd">        :type fops_bath_up: list[tuple[int | str, int | str]], optional,</span>
<span class="sd">            default=[]</span>

<span class="sd">        :param fops_bath_dn: Fundamental operator set for spin-down bath</span>
<span class="sd">            degrees of freedom. Must be empty for calculations without bath.</span>
<span class="sd">        :type fops_bath_dn: list[tuple[int | str, int | str]], optional,</span>
<span class="sd">            default=[]</span>

<span class="sd">        :param input_file: Path to a custom input file compatible with</span>
<span class="sd">            **EDIpack**&#39;s :f:func:`f/ed_input_vars/ed_read_input`.</span>
<span class="sd">            When specified, it is used to initialize **EDIpack**.</span>
<span class="sd">            This option is mutually exclusive with all other keyword arguments.</span>
<span class="sd">        :type input_file: str, optional</span>

<span class="sd">        :param verbose: Verbosity level of the solver: 0 for almost no output,</span>
<span class="sd">            5 for the full output from **EDIpack**.</span>
<span class="sd">        :type verbose: int, default=3</span>

<span class="sd">        :param print_input_vars: Flag to toggle the printing of all the input</span>
<span class="sd">            variables and their values on the console.</span>
<span class="sd">        :type print_input_vars: bool, default=False</span>

<span class="sd">        :param keep_dir: Do not remove **EDIpack**&#39;s temporary directory upon</span>
<span class="sd">                         destruction of this :py:class:`EDIpackSolver` object.</span>
<span class="sd">        :type keep_dir: bool, default=False</span>

<span class="sd">        :param zerotemp: Enable zero temperature calculations.</span>
<span class="sd">        :type zerotemp: bool, default=False</span>

<span class="sd">        :param cutoff: Spectrum cutoff used to determine the number of states</span>
<span class="sd">                       to be retained.</span>
<span class="sd">        :type cutoff: float, default=1e-9</span>

<span class="sd">        :param gs_threshold: Energy threshold for ground state degeneracy loop.</span>
<span class="sd">        :type gs_threshold: float, default=1e-9</span>

<span class="sd">        :param ed_sparse_h: Switch between storing the sparse matrix</span>
<span class="sd">            :math:`\hat H` (*True*) and direct on-the-fly evaluation of</span>
<span class="sd">            the product :math:`\hat H |v\rangle` (*False*).</span>
<span class="sd">        :type ed_sparse_h: bool, default=True</span>

<span class="sd">        :param ed_total_ud: Force use of the total spin-up and spin-down</span>
<span class="sd">            occupancies as quantum numbers instead of the orbital-resolved</span>
<span class="sd">            occupancies.</span>
<span class="sd">        :type ed_total_ud: bool, default=False</span>

<span class="sd">        :param lanc_method: Select the method to be used in</span>
<span class="sd">            the determination of the spectrum, one of *&quot;arpack&quot;*, *&quot;lanczos&quot;*</span>
<span class="sd">            (simple Lanczos method, only works at zero temperature, can be</span>
<span class="sd">            useful in some rare cases, when ARPACK fails) and *&quot;dvdson&quot;*</span>
<span class="sd">            (no-MPI mode only).</span>
<span class="sd">        :type lanc_method: str, default=&quot;arpack&quot;</span>

<span class="sd">        :param lanc_nstates_sector: Initial number of states per sector</span>
<span class="sd">            to be determined.</span>
<span class="sd">        :type lanc_nstates_sector: int, default=2</span>

<span class="sd">        :param lanc_nstates_total: Initial total number of states</span>
<span class="sd">            to be determined.</span>
<span class="sd">        :type lanc_nstates_total: int, default=2</span>

<span class="sd">        :param lanc_nstates_step: Number of states added to the spectrum</span>
<span class="sd">            at each step.</span>
<span class="sd">        :type lanc_nstates_step: int, default=2</span>

<span class="sd">        :param lanc_ncv_factor: Set the size of the block used in</span>
<span class="sd">            Lanczos-ARPACK by multiplying the required Neigen</span>
<span class="sd">            (``NCV = lanc_ncv_factor * Neigen + lanc_ncv_add``).</span>
<span class="sd">        :type lanc_ncv_factor: int, default=10</span>

<span class="sd">        :param lanc_ncv_add: Adds up to the size of the block to prevent it</span>
<span class="sd">            from becoming too small</span>
<span class="sd">            (``NCV = lanc_ncv_factor * Neigen + lanc_ncv_add``).</span>
<span class="sd">        :type lanc_ncv_add: int, default=0</span>

<span class="sd">        :param lanc_niter: Number of Lanczos iterations in spectrum</span>
<span class="sd">            determination.</span>
<span class="sd">        :type lanc_niter: int, default=512</span>

<span class="sd">        :param lanc_ngfiter: Number of Lanczos iterations in GF determination</span>
<span class="sd">            (number of momenta).</span>
<span class="sd">        :type lanc_ngfiter: int, default=200</span>

<span class="sd">        :param lanc_tolerance: Tolerance for the Lanczos iterations as used</span>
<span class="sd">            in ARPACK.</span>
<span class="sd">        :type lanc_tolerance: float, default=1e-18</span>

<span class="sd">        :param lanc_dim_threshold: Minimal dimension threshold to use Lanczos</span>
<span class="sd">            determination of the spectrum rather than LAPACK-based</span>
<span class="sd">            exact diagonalization.</span>
<span class="sd">        :type lanc_dim_threshold: int, default=1024</span>

<span class="sd">        :param bath_fitting_params: Parameters used to perform bath fitting.</span>
<span class="sd">        :type bath_fitting_params: BathFittingParams, optional</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> \
            <span class="s2">&quot;Only one instance of EDIpackSolver can exist at any time&quot;</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fops_imp_up</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fops_imp_up must not be empty&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fops_imp_dn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fops_imp_dn must not be empty&quot;</span>
        <span class="n">validate_fops_up_dn</span><span class="p">(</span><span class="n">fops_imp_up</span><span class="p">,</span> <span class="n">fops_imp_dn</span><span class="p">,</span>
                            <span class="s2">&quot;fops_imp_up&quot;</span><span class="p">,</span> <span class="s2">&quot;fops_imp_dn&quot;</span><span class="p">)</span>
        <span class="n">validate_fops_up_dn</span><span class="p">(</span><span class="n">fops_bath_up</span><span class="p">,</span> <span class="n">fops_bath_dn</span><span class="p">,</span>
                            <span class="s2">&quot;fops_bath_up&quot;</span><span class="p">,</span> <span class="s2">&quot;fops_bath_dn&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">norb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fops_imp_up</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fops_imp_up</span> <span class="o">=</span> <span class="n">fops_imp_up</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fops_imp_dn</span> <span class="o">=</span> <span class="n">fops_imp_dn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fops_bath_up</span> <span class="o">=</span> <span class="n">fops_bath_up</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fops_bath_dn</span> <span class="o">=</span> <span class="n">fops_bath_dn</span>

        <span class="c1"># Detect GF block names</span>
        <span class="n">block_names_up</span> <span class="o">=</span> <span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">fops_imp_up</span><span class="p">]</span>
        <span class="n">block_names_dn</span> <span class="o">=</span> <span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">fops_imp_dn</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">bn</span> <span class="o">!=</span> <span class="n">block_names_up</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">bn</span> <span class="ow">in</span> <span class="n">block_names_up</span><span class="p">):</span>
            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inconsistent block names in </span><span class="si">{</span><span class="n">block_names_up</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">bn</span> <span class="o">!=</span> <span class="n">block_names_dn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">bn</span> <span class="ow">in</span> <span class="n">block_names_dn</span><span class="p">):</span>
            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inconsistent block names in </span><span class="si">{</span><span class="n">block_names_dn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h_params</span> <span class="o">=</span> <span class="n">parse_hamiltonian</span><span class="p">(</span>
            <span class="n">hamiltonian</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fops_imp_up</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fops_imp_dn</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fops_bath_up</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fops_bath_dn</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nspin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">Hloc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Keep temporary directory?</span>
        <span class="n">keep_dir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keep_dir&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keep_dir</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">keep_dir</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;keep_dir=True is ignored on Python versions prior to 3.12&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;input_file&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;input_file&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;input_file&#39; is mutually exclusive with other parameters&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;ED_VERBOSE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;PRINT_INPUT_VARS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;print_input_vars&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;CUTOFF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cutoff&quot;</span><span class="p">,</span> <span class="mf">1e-9</span><span class="p">)</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;GS_THRESHOLD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gs_threshold&quot;</span><span class="p">,</span> <span class="mf">1e-9</span><span class="p">)</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;ED_SPARSE_H&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ed_sparse_h&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;LANC_METHOD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lanc_method&quot;</span><span class="p">,</span> <span class="s2">&quot;arpack&quot;</span><span class="p">)</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;LANC_NSTATES_STEP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lanc_nstates_step&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;LANC_NCV_FACTOR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lanc_ncv_factor&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;LANC_NCV_ADD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lanc_ncv_add&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;LANC_NITER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lanc_niter&quot;</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;LANC_NGFITER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lanc_ngfiter&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;LANC_TOLERANCE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lanc_tolerance&quot;</span><span class="p">,</span> <span class="mf">1e-18</span><span class="p">)</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;LANC_DIM_THRESHOLD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lanc_dim_threshold&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>

            <span class="c1"># Impurity structure</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;ED_MODE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">ed_mode</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;NSPIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspin</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;NORB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norb</span>

            <span class="c1"># Bath geometry</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">bath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">c</span><span class="p">[</span><span class="s2">&quot;BATH_TYPE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">bath</span><span class="o">.</span><span class="n">name</span>
                <span class="n">c</span><span class="p">[</span><span class="s2">&quot;NBATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">bath</span><span class="o">.</span><span class="n">nbath</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span><span class="p">[</span><span class="s2">&quot;NBATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># ed_total_ud</span>
            <span class="n">ed_total_ud</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ed_total_ud&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">denden_int</span> <span class="o">=</span> <span class="n">_is_density_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">U</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="ow">not</span> <span class="n">ed_total_ud</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">ed_mode</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span>
                    <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">bath</span><span class="p">,</span> <span class="p">(</span><span class="n">NoneType</span><span class="p">,</span> <span class="n">BathNormal</span><span class="p">))</span>
                    <span class="ow">and</span> <span class="n">_is_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">Hloc</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">denden_int</span><span class="p">):</span>
                <span class="n">ed_total_ud</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;ED_TOTAL_UD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ed_total_ud</span>

            <span class="c1"># Zero temperature calculations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zerotemp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zerotemp&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;ED_FINITE_TEMP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">zerotemp</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zerotemp</span><span class="p">:</span>
                <span class="n">c</span><span class="p">[</span><span class="s2">&quot;LANC_NSTATES_TOTAL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span><span class="p">[</span><span class="s2">&quot;LANC_NSTATES_TOTAL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lanc_nstates_total&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;LANC_NSTATES_SECTOR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lanc_nstates_sector&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Bath fitting</span>
            <span class="n">bfp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bath_fitting_params&quot;</span><span class="p">,</span> <span class="n">BathFittingParams</span><span class="p">())</span>
            <span class="n">c</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bfp</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">())</span>

            <span class="c1"># Save G, G0 and \Sigma if the temporary directory is to be kept</span>
            <span class="k">if</span> <span class="n">keep_dir</span><span class="p">:</span>
                <span class="n">c</span><span class="p">[</span><span class="s2">&quot;PRINT_SECTOR_EIGENVALUES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">c</span><span class="p">[</span><span class="s2">&quot;ED_PRINT_G&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">c</span><span class="p">[</span><span class="s2">&quot;ED_PRINT_G0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">c</span><span class="p">[</span><span class="s2">&quot;ED_PRINT_SIGMA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">c</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>

        <span class="c1"># A temporary directory for EDIpack is created and managed by the MPI</span>
        <span class="c1"># process with rank 0. The directory is assumed to be accessible to all</span>
        <span class="c1"># other MPI processes under the same name via a common file system.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tdargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;prefix&quot;</span><span class="p">:</span> <span class="s2">&quot;edipack-&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;suffix&quot;</span><span class="p">:</span> <span class="s2">&quot;.tmp&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;dir&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()}</span>
            <span class="k">if</span> <span class="n">keep_dir</span><span class="p">:</span>
                <span class="n">tdargs</span><span class="p">[</span><span class="s2">&quot;delete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">(</span><span class="o">**</span><span class="n">tdargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wdname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wdname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wdname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wdname</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">chdircontext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wdname</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;input.conf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config_file</span><span class="p">:</span>
                        <span class="n">write_config</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;input.conf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
            <span class="n">ed</span><span class="o">.</span><span class="n">read_input</span><span class="p">(</span><span class="s1">&#39;input.conf&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scifor_version</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s2">&quot;^(.*): (.*)&quot;</span><span class="p">,</span>
                    <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;scifor_version.inc&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readline</span><span class="p">())[</span><span class="mi">2</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">edipack_version</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s2">&quot;^(.*): (.*)&quot;</span><span class="p">,</span>
                    <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;EDIpack_version.inc&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readline</span><span class="p">())[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scifor_version</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">edipack_version</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">scifor_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scifor_version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edipack_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edipack_version</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">bath</span><span class="p">,</span> <span class="n">BathGeneral</span><span class="p">):</span>
            <span class="n">ed</span><span class="o">.</span><span class="n">set_hgeneral</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">bath</span><span class="o">.</span><span class="n">hvec</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">bath</span><span class="o">.</span><span class="n">lambdavec</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">bath</span><span class="p">,</span> <span class="p">(</span><span class="n">BathNormal</span><span class="p">,</span> <span class="n">BathHybrid</span><span class="p">)):</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">bath</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">ed</span><span class="o">.</span><span class="n">get_bath_dimension</span><span class="p">()</span>

        <span class="c1"># Initialize EDIpack</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">bath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ed</span><span class="o">.</span><span class="n">init_solver</span><span class="p">(</span>
                <span class="n">bath</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">bath</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ed</span><span class="o">.</span><span class="n">init_solver</span><span class="p">(</span><span class="n">bath</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>

        <span class="c1"># GF block names</span>
        <span class="k">if</span> <span class="n">ed</span><span class="o">.</span><span class="n">get_ed_mode</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>  <span class="c1"># normal or superc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gf_block_names</span> <span class="o">=</span> <span class="p">(</span><span class="n">block_names_up</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">block_names_dn</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gf_block_names</span> <span class="o">=</span> <span class="p">(</span><span class="n">block_names_up</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>

        <span class="k">if</span> <span class="n">ed</span><span class="o">.</span><span class="n">get_ed_mode</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># superc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gf_an_block_names</span> <span class="o">=</span> <span class="p">(</span><span class="n">block_names_up</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                      <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">block_names_dn</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">instance_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ed</span><span class="o">.</span><span class="n">finalize_solver</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="c1"># ed.finalize_solver() can fail if this __del__() method is called as</span>
        <span class="c1"># part of interpreter destruction procedure.</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">hloc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Access to the matrix of the local impurity Hamiltonian</span>
<span class="sd">        :math:`\hat H_\text{loc}`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">Hloc</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">U</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Access to the two-particle interaction tensor</span>
<span class="sd">        :math:`U_{o_1 \sigma_1 o_2 \sigma_2 o_3 \sigma_3 o_4 \sigma_4}`.</span>
<span class="sd">        Contributions to the impurity interaction Hamiltonian are defined</span>
<span class="sd">        according to</span>

<span class="sd">        .. math::</span>

<span class="sd">            \hat H_{int} = \frac{1}{2}</span>
<span class="sd">                \sum_{\sigma_1 \sigma_2 \sigma_3 \sigma_4}\sum_{o_1 o_2 o_3 o_4}</span>
<span class="sd">                    U_{o_1 \sigma_1 o_2 \sigma_2 o_3 \sigma_3 o_4 \sigma_4}</span>
<span class="sd">                    c^\dagger_{\sigma_1 o_1} c^\dagger_{\sigma_2 o_2}</span>
<span class="sd">                    c_{\sigma_4 o_4} c_{\sigma_3 o_3}.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">U</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Bath</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Access to the current :py:class:`bath &lt;edipack2triqs.bath.Bath&gt;` object</span>
<span class="sd">        stored in the solver. It is possible to assign a new bath object as long</span>
<span class="sd">        as it has the matching type and describes a bath of the same geometry.</span>
<span class="sd">        In the no-bath mode this attribute is set to :py:data:`None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">bath</span>

    <span class="nd">@bath</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_bath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Bath</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]):</span>
        <span class="s2">&quot;Set the bath object&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">bath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">new_bath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> \
                <span class="s2">&quot;Cannot set a new bath object in a no-bath calculation&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">bath</span><span class="o">.</span><span class="n">assert_compatible</span><span class="p">(</span><span class="n">new_bath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">bath</span> <span class="o">=</span> <span class="n">new_bath</span>

<div class="viewcode-block" id="EDIpackSolver.solve">
<a class="viewcode-back" href="../../documentation.html#edipack2triqs.solver.EDIpackSolver.solve">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
              <span class="o">*</span><span class="p">,</span>
              <span class="n">n_iw</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">,</span>
              <span class="n">energy_window</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span>
              <span class="n">n_w</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
              <span class="n">broadening</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solve the impurity problem and calculate the observables, Green&#39;s</span>
<span class="sd">        function and self-energy.</span>

<span class="sd">        :param beta:</span>
<span class="sd">            Inverse temperature :math:`\beta = 1 / (k_B T)` for observable and</span>
<span class="sd">            Green&#39;s function calculations. In the zero temperature mode, this</span>
<span class="sd">            parameter determines spacing between fictitious Matsubara</span>
<span class="sd">            frequencies used as a mesh for the Green&#39;s functions.</span>
<span class="sd">        :type beta: float, default=1000</span>

<span class="sd">        :param n_iw: Number of Matsubara frequencies for impurity GF</span>
<span class="sd">            calculations.</span>
<span class="sd">        :type n_iw: int, default=4096</span>

<span class="sd">        :param energy_window: Energy window for real-frequency impurity GF</span>
<span class="sd">            calculations.</span>
<span class="sd">        :type energy_window: tuple[float, float], default=(-5.0, 5.0)</span>

<span class="sd">        :param n_w: Number of real-frequency points for impurity GF</span>
<span class="sd">            calculations.</span>
<span class="sd">        :type n_w: int, default=5000</span>

<span class="sd">        :param broadening: Broadening (imaginary shift away from the</span>
<span class="sd">            real-frequency axis) for real-frequency impurity GF calculations.</span>
<span class="sd">        :type broadening: float, default=0.01</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ed</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
        <span class="n">ed</span><span class="o">.</span><span class="n">Lmats</span> <span class="o">=</span> <span class="n">n_iw</span>
        <span class="n">ed</span><span class="o">.</span><span class="n">wini</span><span class="p">,</span> <span class="n">ed</span><span class="o">.</span><span class="n">wfin</span> <span class="o">=</span> <span class="n">energy_window</span>
        <span class="n">ed</span><span class="o">.</span><span class="n">Lreal</span> <span class="o">=</span> <span class="n">n_w</span>
        <span class="n">ed</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">broadening</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nspin</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">ed_mode</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="ow">not</span> <span class="n">is_spin_diagonal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">Hloc</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Local Hamiltonian must remain spin-diagonal&quot;</span><span class="p">)</span>

        <span class="c1"># The interactions must remain of the density-density type, if this is</span>
        <span class="c1"># how they were at the construction time.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">denden_int</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">_is_density_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">U</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot add non-density-density terms to the interaction&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">chdircontext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wdname</span><span class="p">):</span>
            <span class="c1"># Set H_{loc}</span>
            <span class="n">ed</span><span class="o">.</span><span class="n">set_hloc</span><span class="p">(</span><span class="n">hloc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">Hloc</span><span class="p">)</span>

            <span class="c1"># Add interaction terms</span>
            <span class="n">ed</span><span class="o">.</span><span class="n">reset_umatrix</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">o1</span><span class="p">,</span> <span class="n">o2</span><span class="p">,</span> <span class="n">o3</span><span class="p">,</span> <span class="n">o4</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span><span class="p">,</span> <span class="n">s4</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;u&#39;</span> <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">ed</span><span class="o">.</span><span class="n">add_twobody_operator</span><span class="p">(</span><span class="n">o1</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">o2</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">o3</span><span class="p">,</span> <span class="n">s3</span><span class="p">,</span> <span class="n">o4</span><span class="p">,</span> <span class="n">s4</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

            <span class="c1"># Solve!</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">bath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ed</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_params</span><span class="o">.</span><span class="n">bath</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ed</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">e_pot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="s2">&quot;Potential energy from interaction.&quot;</span>
        <span class="k">return</span> <span class="n">ed</span><span class="o">.</span><span class="n">get_eimp</span><span class="p">(</span><span class="n">ikind</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">e_kin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="s2">&quot;Kinetic energy.&quot;</span>
        <span class="k">return</span> <span class="n">ed</span><span class="o">.</span><span class="n">get_eimp</span><span class="p">(</span><span class="n">ikind</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">densities</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="s2">&quot;Impurity occupations, one element per orbital.&quot;</span>
        <span class="k">return</span> <span class="n">ed</span><span class="o">.</span><span class="n">get_dens</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">double_occ</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="s2">&quot;Impurity double occupancy, one element per orbital.&quot;</span>
        <span class="k">return</span> <span class="n">ed</span><span class="o">.</span><span class="n">get_docc</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">superconductive_phi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modulus of the impurity superconductive order parameter</span>
<span class="sd">        :math:`\phi = \langle c_{o_1,\uparrow} c_{o_2,\downarrow} \rangle`</span>
<span class="sd">        (matrix in the orbital space).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ed</span><span class="o">.</span><span class="n">get_phi</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;mod&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">superconductive_phi_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Complex argument of the impurity superconductive order parameter</span>
<span class="sd">        :math:`\phi = \langle c_{o_1,\uparrow} c_{o_2,\downarrow} \rangle`</span>
<span class="sd">        (matrix in the orbital space).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ed</span><span class="o">.</span><span class="n">get_phi</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;arg&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">magnetization</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cartesian components of impurity magnetization vectors,</span>
<span class="sd">        one row per orbital.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ed</span><span class="o">.</span><span class="n">get_mag</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_gf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ed_func</span><span class="p">,</span> <span class="n">real_freq</span><span class="p">,</span> <span class="n">anomalous</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockGf</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">anomalous</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ed</span><span class="o">.</span><span class="n">get_ed_mode</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># superc</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;anomalous = True is only supported for &quot;</span>
                                   <span class="s2">&quot;superconducting bath&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">real_freq</span><span class="p">:</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">MeshReFreq</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="p">(</span><span class="n">ed</span><span class="o">.</span><span class="n">wini</span><span class="p">,</span> <span class="n">ed</span><span class="o">.</span><span class="n">wfin</span><span class="p">),</span> <span class="n">n_w</span><span class="o">=</span><span class="n">ed</span><span class="o">.</span><span class="n">Lreal</span><span class="p">)</span>
            <span class="n">z_vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">complex</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">ed</span><span class="o">.</span><span class="n">eps</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">mesh</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">MeshImFreq</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="n">ed</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">S</span><span class="o">=</span><span class="s2">&quot;Fermion&quot;</span><span class="p">,</span> <span class="n">n_iw</span><span class="o">=</span><span class="n">ed</span><span class="o">.</span><span class="n">Lmats</span><span class="p">)</span>
            <span class="n">z_vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">complex</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">mesh</span><span class="p">]</span>

        <span class="k">with</span> <span class="n">chdircontext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wdname</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">ed_func</span><span class="p">(</span><span class="n">z_vals</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="s1">&#39;a&#39;</span> <span class="k">if</span> <span class="n">anomalous</span> <span class="k">else</span> <span class="s1">&#39;n&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">anomalous</span><span class="p">:</span>
            <span class="n">F</span> <span class="o">=</span> <span class="n">Gf</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">target_shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">norb</span><span class="p">))</span>
            <span class="n">F</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rollaxis</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">BlockGf</span><span class="p">(</span><span class="n">name_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gf_an_block_names</span><span class="p">,</span>
                           <span class="n">block_list</span><span class="o">=</span><span class="p">[</span><span class="n">F</span><span class="p">],</span>
                           <span class="n">make_copies</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ed</span><span class="o">.</span><span class="n">get_ed_mode</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>  <span class="c1"># 2 spin blocks</span>
            <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Gf</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">target_shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">norb</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="c1"># Block up</span>
            <span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rollaxis</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="mi">2</span><span class="p">)</span>
            <span class="c1"># Block down</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspin</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rollaxis</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># One block</span>
            <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Gf</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">target_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">norb</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">norb</span><span class="p">))</span>
            <span class="p">]</span>
            <span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">norb</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">norb</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">BlockGf</span><span class="p">(</span><span class="n">name_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gf_block_names</span><span class="p">,</span>
                       <span class="n">block_list</span><span class="o">=</span><span class="n">blocks</span><span class="p">,</span>
                       <span class="n">make_copies</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># GF and self-energy properties</span>
    <span class="c1">#</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">g_iw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockGf</span><span class="p">:</span>
        <span class="s2">&quot;Matsubara impurity Green&#39;s function.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_gf</span><span class="p">(</span><span class="n">ed</span><span class="o">.</span><span class="n">build_gimp</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">g_an_iw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockGf</span><span class="p">:</span>
        <span class="s2">&quot;Anomalous Matsubara impurity Green&#39;s function.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_gf</span><span class="p">(</span><span class="n">ed</span><span class="o">.</span><span class="n">build_gimp</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Sigma_iw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockGf</span><span class="p">:</span>
        <span class="s2">&quot;Matsubara impurity self-energy.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_gf</span><span class="p">(</span><span class="n">ed</span><span class="o">.</span><span class="n">build_sigma</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Sigma_an_iw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockGf</span><span class="p">:</span>
        <span class="s2">&quot;Anomalous Matsubara impurity self-energy.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_gf</span><span class="p">(</span><span class="n">ed</span><span class="o">.</span><span class="n">build_sigma</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">g_w</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockGf</span><span class="p">:</span>
        <span class="s2">&quot;Real-frequency impurity Green&#39;s function.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_gf</span><span class="p">(</span><span class="n">ed</span><span class="o">.</span><span class="n">build_gimp</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">g_an_w</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockGf</span><span class="p">:</span>
        <span class="s2">&quot;Anomalous real-frequency impurity Green&#39;s function.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_gf</span><span class="p">(</span><span class="n">ed</span><span class="o">.</span><span class="n">build_gimp</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Sigma_w</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockGf</span><span class="p">:</span>
        <span class="s2">&quot;Real-frequency impurity self-energy.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_gf</span><span class="p">(</span><span class="n">ed</span><span class="o">.</span><span class="n">build_sigma</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Sigma_an_w</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockGf</span><span class="p">:</span>
        <span class="s2">&quot;Anomalous real-frequency impurity self-energy.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_gf</span><span class="p">(</span><span class="n">ed</span><span class="o">.</span><span class="n">build_sigma</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Bath fitting</span>
    <span class="n">chi2_fit_bath</span> <span class="o">=</span> <span class="n">_chi2_fit_bath</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024-2025, Igor Krivenko, Lorenzo Crippa.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>